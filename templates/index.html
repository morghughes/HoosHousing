{% load static %}
{% load socialaccount %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Google OAuth Project</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            background-color: #2b5fc8;
        }
        .container {
            padding-top: 50px;
        }
        .card {
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        {% if user.is_authenticated %}
            <div class="card">
                <div class="card-header">
                    <h4>Welcome, {% if user.first_name %}{{ user.first_name }}{% else %}{{ user.username }}{% endif %}!</h4>
                </div>
                <div class="card-body">
                    <div> <a href="{% url 'report' %}">Submit a New Report</a> </div>
                    <div> <a href="{% url 'view_reports' %}">View Reports</a> </div>
                    <div id="messages"></div>

                    <script type="text/javascript">
                        document.getElementById('file-upload-form').addEventListener('submit', function(e) {
                            e.preventDefault();
                            var formData = new FormData(this);
                            fetch("{% url 'upload' %}", {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                                },
                            })
                            .then(response => {
                                if(response.ok) {
                                    return response.json();
                                } else {
                                    throw new Error('Server response wasn\'t OK');
                                }
                            })
                            .then(data => {
                                document.getElementById('messages').innerHTML =
                                    '<p class="alert alert-success">File uploaded successfully! <a href="' + data.file_url + '" target="_blank">Click here to view your file</a>.</p>';
                            })
                            .catch(error => {
                                document.getElementById('messages').innerHTML =
                                    '<p class="alert alert-danger">Error uploading file. Please try again.</p>';
                                console.error('Error:', error);
                            });
                        });
                    </script>
                </div>
            </div>
            <form action="{% url 'logout' %}" method="post">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">Logout</button>
            </form>
        {% else %}
            <div class="card">
                <div class="card-header">
                    <h4>Login</h4>
                </div>
                <div class="card-body">
                    <a href="{% provider_login_url 'google' %}" class="btn btn-primary">Login With Google</a>
                </div>
            </div>
        {% endif %}
    </div>
</body>
</html>
